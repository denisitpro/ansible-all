---
- name: copy zabbix_agent2.conf - base
  template:
      src: zabbix_agent2.conf.j2
      dest: /etc/zabbix/zabbix_agent2.conf
  notify: restart zabbix-agent2
  when: zabbix.owner is not defined
  tags:
    - zabbix-conf
    - zabbix

- name: copy zabbix_agent2.conf - owner defined
  template:
      src: zabbix_agent2_htz.conf.j2
      dest: /etc/zabbix/zabbix_agent2.conf
  notify: restart zabbix-agent2
  when: zabbix.owner is  defined
  tags:
    - zabbix-conf
    - zabbix


- name: copy ansible autogenerate userparams.conf
  template:
      src: "ansible_autogen.conf.j2"
      dest: "/etc/zabbix/zabbix_agent2.d/ansible_autogen.conf"
      mode: 0640
      owner: zabbix
      group: zabbix
  when: zabbix.params is defined
  notify: restart zabbix-agent2
  tags:
    - zabbix-conf

#- name: copy clickhouse_userparams.conf
#  template:
#      src: clickhouse_userparams.conf.j2
#      dest: "/etc/zabbix/zabbix_agent2.d/clickhouse_userparams.conf"
#      mode: 0640
#      owner: zabbix
#      group: zabbix
#  when: ch_host_type == "clickhouse_slave"
#  notify: restart zabbix-agent2
#  tags:
#    - zabbix-conf

- name: create scripts dir
  file:
    path: "{{ zabbix_scripts_path }}"
    state: directory
    recurse: yes
  when: zabbix.scripts is defined
  tags:
    - zabbix-conf

- name: copy user scripts
  copy:
      src: "scripts/{{item}}"
      dest: "{{ zabbix_scripts_path }}/{{item}}"
      force : True
      mode: a+rx
  with_items:
    - "{{ zabbix.scripts }}"
  when: zabbix.scripts is defined
  notify: restart zabbix-agent2
  tags:
    - zabbix-conf

- name: "restart zabbix-agent2"
  ansible.builtin.systemd:
    name: "zabbix-agent2"
    state: restarted
  tags:
    - never
    - zabbix-agent-restart