---
- name: copy vhosts
  ansible.builtin.template:
    src: "shared/templates/vhosts/{{ item.config_file | default('vhost-general-g3.conf.j2') }}"
    dest: "{{ angie_base_path }}/site.d/{{ item.servername.split(' ')[0] }}.conf"
    owner: "{{ angie_uid }}"
    group: "{{ angie_gid }}"
    mode: "0644"
  with_items: "{{ nginx.vhosts }}"
  when:
    - nginx.vhosts is defined
    - nginx.vhosts | type_debug == "list"
    - nginx.vhosts | length > 0

- name: Copy default site - deny access not unknow sites
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: "{{ angie_base_path }}/site.d/{{ item }}"
    owner: "{{ angie_uid }}"
    group: "{{ angie_gid }}"
    mode: '0644'
  loop:
    - default-deny.conf
  when:
    - nginx.streams is not defined
  tags:
    - angie-default-deny
    - default-deny
