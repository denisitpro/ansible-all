# Скрипт резервного копирования backup-directory.sh

## Описание

Скрипт `backup-directory.sh` предназначен для создания резервных копий директорий с поддержкой различных режимов работы: упаковка файлов в архив или только шифрование без упаковки.

## Основные возможности

- **Упаковка файлов**: Создание tar-архивов с опциональным сжатием
- **Шифрование**: GPG шифрование архивов или отдельных файлов
- **Гибкие настройки**: Настройка сжатия, шифрования и упаковки
- **Автоочистка**: Удаление старых бэкапов по заданному сроку хранения
- **Логирование**: Подробное логирование процесса создания бэкапа

## Синтаксис

```bash
./backup-directory.sh --source <source_directory> [options]
```

## Параметры

### Обязательные параметры
- `--source <path>` - Исходная директория для резервного копирования

### Опциональные параметры
- `--dest <path>` - Директория назначения (по умолчанию: `/mnt/backup`)
- `--prefix <string>` - Префикс имени файла бэкапа (по умолчанию: `backup`)
- `--retention <days>` - Срок хранения бэкапов в днях (по умолчанию: `3`)
- `--gpg-recipient <key>` - GPG ключ получателя (по умолчанию: из конфигурации)
- `--no-encrypt` - Отключить GPG шифрование
- `--no-compress` - Отключить сжатие
- `--no-pack` - Отключить упаковку файлов (только шифрование)
- `--log-file <path>` - Путь к файлу логов (по умолчанию: `/var/log/backup.log`)
- `--help` - Показать справку

## Примеры использования

### 1. Стандартный режим (упаковка + сжатие + шифрование)
```bash
# Создание полного бэкапа с упаковкой, сжатием и шифрованием
./backup-directory.sh --source /opt/data
```
**Результат**: `backup_20241201_143022.tar.gz.gpg`

### 2. Режим только шифрования (без упаковки)
```bash
# Шифрование файлов напрямую без создания архива
./backup-directory.sh --source /opt/data --no-pack
```
**Результат**: `backup_20241201_143022.gpg`

### 3. Упаковка без шифрования
```bash
# Создание сжатого архива без шифрования
./backup-directory.sh --source /var/log --no-encrypt
```
**Результат**: `backup_20241201_143022.tar.gz`

### 4. Только упаковка без сжатия
```bash
# Создание tar-архива без сжатия и шифрования
./backup-directory.sh --source /home/user --no-encrypt --no-compress
```
**Результат**: `backup_20241201_143022.tar`

### 5. Настройка параметров
```bash
# Бэкап с пользовательскими настройками
./backup-directory.sh \
  --source /opt/application \
  --dest /backup/custom \
  --prefix app_backup \
  --retention 7 \
  --log-file /var/log/custom_backup.log
```

### 6. Бэкап логов с коротким сроком хранения
```bash
# Бэкап логов с хранением 1 день
./backup-directory.sh \
  --source /var/log \
  --prefix logs \
  --retention 1 \
  --no-encrypt
```

### 7. Шифрование конфиденциальных данных
```bash
# Шифрование конфиденциальных файлов без упаковки
./backup-directory.sh \
  --source /home/confidential \
  --prefix secret_data \
  --no-pack \
  --retention 30
```

## Режимы работы

### Режим упаковки (по умолчанию)
- Создает tar-архив из исходной директории
- Опционально применяет gzip сжатие
- Опционально шифрует архив с помощью GPG
- Подходит для полного резервного копирования

### Режим только шифрования
- Шифрует файлы напрямую без создания архива
- Сохраняет структуру директорий внутри зашифрованного файла
- Подходит для конфиденциальных данных
- Требует обязательного шифрования

## Файлы результатов

| Режим | Сжатие | Шифрование | Расширение файла |
|-------|--------|------------|------------------|
| Упаковка | Да | Да | `.tar.gz.gpg` |
| Упаковка | Да | Нет | `.tar.gz` |
| Упаковка | Нет | Да | `.tar.gpg` |
| Упаковка | Нет | Нет | `.tar` |
| Только шифрование | - | Да | `.gpg` |

## Автоматическая очистка

Скрипт автоматически удаляет старые бэкапы:
- Для упакованных бэкапов: ищет файлы `prefix_*.tar.gz*`
- Для зашифрованных файлов: ищет файлы `prefix_*.gpg`
- Удаляет файлы старше указанного количества дней

## Логирование

Все операции записываются в лог-файл с временными метками:
```
2024-12-01 14:30:22 [12345] Starting backup of /opt/data
2024-12-01 14:30:25 [12345] Backup completed successfully. Size: 150M
2024-12-01 14:30:26 [12345] Cleanup completed. Remaining backup files: 3
```

## Требования

- `tar` - для создания архивов
- `gzip` - для сжатия (если включено)
- `gpg` - для шифрования (если включено)
- GPG ключ получателя должен быть импортирован в систему

## Обработка ошибок

Скрипт завершается с ошибкой в следующих случаях:
- Исходная директория не существует
- Невозможно создать бэкап без упаковки и шифрования
- Ошибки при создании архива или шифровании
- Проблемы с правами доступа к директориям
