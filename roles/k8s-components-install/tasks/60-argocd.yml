---
- name: ArgoCD - Ensure Helm is installed
  ansible.builtin.command: helm version
  register: helm_check
  failed_when: helm_check.rc != 0
  changed_when: false

- name: ArgoCD - Check if argocd is already installed
  ansible.builtin.shell: |
    helm list -n {{ helm_argocd_namespace | default('argocd') }} --kubeconfig {{ k8s_config_path }} | grep -w argocd
  register: argocd_installed
  failed_when: false
  changed_when: false
  tags:
    - argocd-cm

- name: ArgoCD - Set fact whether to skip argocd install
  ansible.builtin.set_fact:
    skip_argocd_install: "{{ argocd_installed.rc == 0 and (not argocd_force_install | default(false)) }}"
  tags:
    - argocd-cm

- name: ArgoCD - Add Helm repository
  ansible.builtin.command: helm repo add argo https://argoproj.github.io/argo-helm
  register: helm_argocd_repo
  changed_when: "'\"has been added\"' in helm_argocd_repo.stdout"
  when: not skip_argocd_install

- name: ArgoCD - Update Helm repos
  ansible.builtin.command: helm repo update
  when: not skip_argocd_install


- name: ArgoCD - Create values config from template
  ansible.builtin.template:
    src: "argocd-values.yaml.j2"
    dest: /tmp/argocd-values.yaml
    mode: "0644"
  when: not skip_argocd_install

- name: ArgoCD - Install via Helm
  ansible.builtin.command: >
    helm upgrade --install argocd argo/argo-cd
    --namespace {{ helm_argocd_namespace | default('argocd') }}
    --version {{ helm_argocd_version | default('8.3.1') }}
    --kubeconfig {{ k8s_config_path }}
    --create-namespace
    --values /tmp/argocd-values.yaml
  when: not skip_argocd_install or argocd_force_install is defined

- name: ArgoCD - Create cm
  ansible.builtin.template:
    src: "{{ item }}.j2"
    dest: /tmp/{{ item }}
    mode: "0600"
  when: (skip_argocd_install and argocd_github_enabled is defined) or argocd_force_install is defined
  with_items:
    - argocd-cm.yml
    - argocd-rbac-cm.yml
    - argocd-projects.yml
  tags:
    - argocd-cm

- name: ArgoCD - Install cm
  ansible.builtin.command: >
    kubectl apply -f /tmp/{{ item }}
    --namespace {{ helm_argocd_namespace | default('argocd') }}
    --kubeconfig {{ k8s_config_path }}
  when: (skip_argocd_install and argocd_github_enabled is defined) or argocd_force_install is defined
  with_items:
    - argocd-cm.yml
    - argocd-rbac-cm.yml
    - argocd-projects.yml
  tags:
    - argocd-cm


- name: ArgoCD - Remove cm
  ansible.builtin.file:
    path: /tmp/{{ item }}
    state: absent
  with_items:
    - argocd-cm.yml
    - argocd-rbac-cm.yml
    - argocd-projects.yml
    - argocd-cert.yaml
  tags:
    - argocd-cm
