---
# Apply K8s labels to ingress nodes based on Terraform state data
# Uses variable name specified in label_output_var_name (defined in inventory)
# Variable is populated by terraform-read-remote-state-g3 role

- name: Verify label_output_var_name is defined
  ansible.builtin.assert:
    that:
      - label_output_var_name is defined
    fail_msg: "Variable label_output_var_name is not defined. Define it in inventory group_vars (e.g., label_output_var_name: k8s_ingress_nodes_prod)"
    success_msg: "Using variable '{{ label_output_var_name }}' for ingress nodes list"

- name: Get ingress nodes list from specified variable
  ansible.builtin.set_fact:
    k8s_ingress_nodes_current: "{{ lookup('vars', label_output_var_name) }}"

- name: Verify ingress nodes variable is defined and not empty
  ansible.builtin.assert:
    that:
      - k8s_ingress_nodes_current is defined
      - k8s_ingress_nodes_current | length > 0
    fail_msg: "Variable '{{ label_output_var_name }}' is not defined or empty. Make sure terraform-read-remote-state-g3 role ran successfully."
    success_msg: "Found {{ k8s_ingress_nodes_current | length }} ingress node(s) to label"

- name: Debug ingress nodes from Terraform state
  ansible.builtin.debug:
    msg: "Will apply label {{ k8s_ingress_label_key }}={{ k8s_ingress_label_value }} to node {{ item.name }}"
  loop: "{{ k8s_ingress_nodes_current }}"

- name: Apply ingress label to nodes from Terraform state
  ansible.builtin.command: >
    kubectl label nodes {{ item.name }}
    {{ k8s_ingress_label_key }}={{ k8s_ingress_label_value }}
    --overwrite
    --kubeconfig {{ k8s_config_path }}
  loop: "{{ k8s_ingress_nodes_current }}"
  register: label_result
  changed_when: "'labeled' in label_result.stdout or 'not labeled' not in label_result.stdout"
  failed_when: label_result.rc != 0 and 'not found' in label_result.stderr

- name: Display labeling results
  ansible.builtin.debug:
    msg: "Successfully labeled {{ k8s_ingress_nodes_current | length }} ingress node(s)"
