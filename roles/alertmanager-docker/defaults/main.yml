---
# base directory config
alertmanager_docker_compose_path: "{{ docker_compose_path | default('/opt/docker') }}/alertmanager"
alertmanager_data_path: /opt/alertmanager
alertmanager_db_dir: "{{ alertmanager_data_path }}/data"
alertmanager_config_path: "{{ alertmanager_data_path }}/config"
alertmanager_config_dir: /etc/alertmanager
alertmanager_user_uid: "65534"
alertmanager_user_gid: "65534"
#version and bind
alertmanager_image: "v0.27.0"
alertmanager_bind_address: "{{ global_bind_addr | default ('[::]')}}"
alertmanager_http_location: "/"
alertmanager_web_listen_address: "{{ alertmanager_bind_address }}:9093"
alertmanager_web_external_url: "http://{{ alertmanager_bind_address }}:9093{{ alertmanager_http_location }}"

alertmanager_telegram_bot_token: "{{ vault_dict_users_secret.alertmanager_telegram_bot_token  | default('set_me') }}"


#command to run
alertmanager_command_run:
  - "config.file={{ alertmanager_config_dir }}/alertmanager.yml"
  - "storage.path={{ alertmanager_db_dir }}"
  - "web.listen-address={{ alertmanager_web_listen_address }}"
  - "web.external-url={{ alertmanager_web_external_url }}"
  - cluster.listen-address="" # disable HA

# config section
alertmanager_template_files:
  - general.tmpl
  - my.tmpl
#  - slack.tmpl
  - telegram.tmpl

alertmanager_config_file: 'alertmanager.yml.j2'
alertmanager_http_config: {}
alertmanager_resolve_timeout: 3m
alertmanager_config_flags_extra: {}
alertmanager_smtp: {}
# Default values you can see here -> https://prometheus.io/docs/alerting/configuration/
alertmanager_pagerduty_url: ''
alertmanager_opsgenie_api_key: ''
alertmanager_opsgenie_api_url: ''
alertmanager_hipchat_api_url: ''
alertmanager_hipchat_auth_token: ''
alertmanager_wechat_url: ''
alertmanager_wechat_secret: ''
alertmanager_wechat_corp_id: ''
# First read: https://github.com/prometheus/alertmanager#high-availability
alertmanager_cluster:
  listen-address: ""

alertmanager_inhibit_rules: []
alertmanager_child_routes: []

#alertmanager_route: {}
# this config use only test launch, need redefine variable in group_vars
#alertmanager_slack_api_url: "https://example.webhook.com"
#alertmanager_route:
#  group_by: ['alertname', 'cluster', 'service']
#  group_wait: 30s
#  group_interval: 5m
#  repeat_interval: 4h
#  receiver: example-alerts
alertmanager_route:
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: receiver-telegram-prom
  routes:
  - match:
      alertname: Watchdog
    group_by: ['alertname']
    receiver: receiver-telegram-prom
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 24h

#alertmanager_receivers:
#  - name: "example-alerts"
#    webhook_configs:
#    slack_configs:
#      - send_resolved: true
#        channel: '#example-prom'
#        color: !unsafe '{{ template "slack.color" . }}'
#        title: !unsafe '{{ template "slack.title" . }}'
#        text: !unsafe '{{ template "slack.text" . }}'

alertmanager_receivers:
  - name: "receiver-telegram-prom"
    telegram_configs:
      - bot_token: "{{alertmanager_telegram_bot_token}}"
        api_url: https://api.telegram.org
        chat_id: -123456
        message: !unsafe '{{ template "telegram.default_notify.message" . }}'
#        parse_mode: HTML