# - name: Download tfstate
#   ansible.builtin.shell: aws s3 cp s3://c1-s3-backend-c1-devel-g1/env/c1-infra-twc/terraform.tfstate /tmp/state.json --region eu-central-1 --profile c1_devel_s3_rw
#   args:
#     executable: /bin/bash
#   register: tf

# - name: Parse state
#   ansible.builtin.set_fact:
#     tfstate: "{{ lookup('file', '/tmp/state.json') | from_json }}"

- name: Read tfstate directly from S3 (pure stdout)
  ansible.builtin.shell: >
    aws s3 cp s3://c1-s3-backend-c1-devel-g1/env/c1-infra-twc/terraform.tfstate - 
    --region eu-central-1
    --profile c1_devel_s3_rw
  args:
    executable: /bin/bash
  register: tf_raw
  changed_when: false
  delegate_to: localhost

- name: Parse tfstate json from stdout
  ansible.builtin.set_fact:
    tfstate: "{{ tf_raw.stdout | from_json }}"

- name: Set srv_vpn_key_twc with name, ipv4, ipv6
  ansible.builtin.set_fact:
    srv_vpn_key_twc:
      name: >-
        {{
          (
            tfstate.resources
            | selectattr('type', 'equalto', 'twc_server')
            | selectattr('name', 'equalto', 'vpn_key_twc')
            | map(attribute='instances')
            | first
          )[0].attributes.name
        }}
      ipv4: >-
        {{
          (
            tfstate.resources
            | selectattr('type', 'equalto', 'twc_server')
            | selectattr('name', 'equalto', 'vpn_key_twc')
            | map(attribute='instances')
            | first
          )[0].attributes.main_ipv4
        }}
      ipv6: >-
        {{
          (
            tfstate.resources
            | selectattr('type', 'equalto', 'twc_server')
            | selectattr('name', 'equalto', 'vpn_key_twc')
            | map(attribute='instances')
            | first
          )[0].attributes.networks[0].ips
          | selectattr('type', 'equalto', 'ipv6')
          | map(attribute='ip')
          | first
        }}

- name: Debug srv_vpn_key_twc
  ansible.builtin.debug:
    var: srv_vpn_key_twc

- name: Remove directory data
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "/tmp/state.json"
