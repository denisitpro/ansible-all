---
- import_tasks: shared/tasks/create-dir-docker-compose.yml

- name: create folder for node
  ansible.builtin.file:
    path: "{{item}}"
    state: directory
    mode: '0755'
    owner: root
    group: zabbix
  with_items:
    - "{{docker_compose_path | default('/opt/docker')}}/polygon"
    - "{{matic_node_data_path}}"
    - "{{matic_node_data_path}}/node"
    - "{{matic_node_data_path}}/heimdall"
    - "{{matic_node_data_path}}/heimdall/config"
    - "{{matic_node_data_path}}/heimdall/data"
    - "{{matic_node_data_path}}/rabbitmq"

- name: copy genesis file matic
  copy:
    src: "genesis.json"
    dest: "{{matic_node_data_path}}/node/genesis.json"
    owner: root
    group: root
    mode: 0644

- name: copy polygon config
  template:
    src: "matic.toml.j2"
    dest: "{{matic_node_data_path}}/node/matic.toml"
    owner: root
    group: root
    mode: 0644
  tags:
    - polygon-conf

- name: copy genesis heimdall
  copy:
    src: "genesis-heimdal.json"
    dest: "{{matic_node_data_path}}/heimdall/config/genesis.json"
    owner: root
    group: root
    mode: 0644

- name: copy node_key
  copy:
    src: "{{heimdall_node_key_filename}}"
    dest: "{{matic_node_data_path}}/heimdall/config/node_key.json"
    owner: root
    group: root
    mode: 0600

- name: copy priv_validator_key.json
  copy:
    src: "{{heimdall_priv_validator_key_filename}}"
    dest: "{{matic_node_data_path}}/heimdall/config/priv_validator_key.json"
    owner: root
    group: root
    mode: 0600

- name: copy heimdall configs
  template:
    src: "{{item}}.j2"
    dest: "{{matic_node_data_path}}/heimdall/config/{{item}}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - "app.toml"
    - "config.toml"
    - "heimdall-config.toml"

# check priv_validator_state.json

- name: check priv_validator_state.json init phase
  stat:
    path: "{{matic_node_data_path}}/heimdall/data/priv_validator_state.json"
  register: priv_validator_state_init_result

- name: print priv_validator_state_init_result init status
  ansible.builtin.debug:
    msg: priv_validator_state_init_result {{ priv_validator_state_init_result.stat.exists }}

- name: copy priv_validator_state
  copy:
    src: "priv_validator_state.json"
    dest: "{{matic_node_data_path}}/heimdall/data/priv_validator_state.json"
    mode: 0600
  when: priv_validator_state_init_result.stat.exists == False
