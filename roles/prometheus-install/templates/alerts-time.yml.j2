
{{ ansible_managed | comment }}

groups:
- name: time alert rules
  rules:

  - alert: NodeClockSkewDetected - 0.15 seconds (150 ms)
    annotations:
      summary: "{% raw %}Clock skew detected (instance {{ $labels.instance }}){% endraw %}"
      description: "{% raw %}Clock at {{ $labels.instance }} is out of sync by more than 0.15s. Ensure NTP is configured correctly on this host. VALUE = {{ printf \"%.8f\" $value }}s{% endraw %}"
    expr: ((node_timex_offset_seconds > 0.15 and deriv(node_timex_offset_seconds[5m]) >= 0) or (node_timex_offset_seconds < -0.15 and deriv(node_timex_offset_seconds[5m]) <= 0))
    for: 10m
    labels:
      severity: warning
    # Description: Triggers when clock offset > 150ms with derivative check for 10 minutes
    # This alert duplicates ClockSkewDetected g2 functionality with higher threshold (150ms vs 15ms)
    # The derivative logic adds complexity without providing significant value over the simpler alert

  - alert: ClockSkewDetected g2
    expr: abs(node_timex_estimated_error_seconds) * 1000 > 15
    for: 5m
    labels:
      severity: warning
    annotations:
      description: "{% raw %}Clock skew detected on {{ $labels.instance }}. Ensure NTP is configured correctly on this host.{% endraw %}"
      summary: "{% raw %}Instance {{ $labels.instance }} - Clock skew detected{% endraw %}"
    # Description: Triggers when clock error exceeds 15ms for 5 minutes

  - alert: NodeClockNotSynchronising
    annotations:
      description: "{% raw %}Clock at {{ $labels.instance }} is not synchronising. Ensure NTP is configured on this host.{% endraw %}"
      summary: Clock not synchronising.
    expr: |
      min_over_time(node_timex_sync_status[5m]) == 0
      and
      node_timex_maxerror_seconds{job="node-exporter"} >= 16
    for: 10m
    labels:
      severity: warning
    # Description: Triggers when NTP sync status is 0 and max error >= 16s for 10 minutes

  - alert: ClockSkewDetectedStable [DEPRECATED]
    expr: |
      (abs(node_timex_offset_seconds offset 2m) > 0.05)
      and ignoring(instance)
      (changes(node_timex_offset_seconds[2m]) < 5)
    for: 2m
    labels:
      severity: warning
    annotations:
      description: "{% raw %}Stable clock skew detected on {{ $labels.instance }}. Offset > 50ms over 2m.{% endraw %}"
      summary: "{% raw %}Instance {{ $labels.instance }} - clock offset is stable and too high: {{ humanize $value }}{% endraw %}"
    # Description: Triggers when clock offset > 50ms is stable for 2 minutes
    # DEPRECATED: This alert is overly complex and conflicts with simpler ClockSkewDetected g2
    # The stable offset logic adds unnecessary complexity and can miss real-time issues
