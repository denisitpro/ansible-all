---
- name: Read tfstate directly from S3 (pure stdout)
  ansible.builtin.shell: >
    aws s3 cp s3://{{ item.s3_bucket }}/{{ item.s3_key }} -
    --region {{ item.s3_region }}
    --profile {{ item.s3_profile }}
  args:
    executable: /bin/bash
  register: tf_raw
  changed_when: false

- name: Debug run task
  ansible.builtin.debug:
    msg: "Processing Hetzner Load Balancer provider for {{ item.name }}"

# - name: Debug tf_raw
#   ansible.builtin.debug:
#     var: tf_raw

- name: Parse tfstate json from stdout
  ansible.builtin.set_fact:
    tfstate: "{{ tf_raw.stdout | from_json }}"

# - name: Debug tfstate
#   ansible.builtin.debug:
#     var: tfstate

# - name: Debug resources structure
#   ansible.builtin.debug:
#     msg: "Resource type: {{ resource_item.type }}, name: {{ resource_item.name }}, Available resources: {{ tfstate.resources | map(attribute='type') | list }}"
#   loop: "{{ item.resources | selectattr('type', 'equalto', 'hcloud_load_balancer') | list }}"
#   loop_control:
#     loop_var: resource_item

# - name: Debug specific resources
#   ansible.builtin.debug:
#     msg: "Resources of type {{ resource_item.type }}: {{ tfstate.resources | selectattr('type', 'equalto', resource_item.type) | map(attribute='name') | list }}"
#   loop: "{{ item.resources | selectattr('type', 'equalto', 'hcloud_load_balancer') | list }}"
#   loop_control:
#     loop_var: resource_item

# - name: Debug found resource
#   ansible.builtin.debug:
#     msg: "Found resource: {{ tfstate.resources | selectattr('type', 'equalto', resource_item.type) | selectattr('name', 'equalto', resource_item.name) | first }}"
#   loop: "{{ item.resources | selectattr('type', 'equalto', 'hcloud_load_balancer') | list }}"
#   loop_control:
#     loop_var: resource_item

- name: Set load balancer data array for each resource (supports count)
  ansible.builtin.set_fact:
    "lb_{{ resource_item.name }}": >-
      [
        {% for instance in (tfstate.resources | selectattr('type', 'equalto', resource_item.type) | selectattr('name', 'equalto', resource_item.name) | map(attribute='instances') | first) %}
        {
          "name": "{{ instance.attributes.name }}",
          "ipv4": "{{ instance.attributes.ipv4 }}",
          "ipv6": "{{ instance.attributes.ipv6 }}",
          "id": "{{ instance.attributes.id }}"
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
  loop: "{{ item.resources | selectattr('type', 'equalto', 'hcloud_load_balancer') | list }}"
  loop_control:
    loop_var: resource_item

- name: Debug extracted data for each load balancer
  ansible.builtin.debug:
    msg: "Load Balancer {{ resource_item.name }}: {{ hostvars[inventory_hostname]['lb_' + resource_item.name] }}"
  loop: "{{ item.resources | selectattr('type', 'equalto', 'hcloud_load_balancer') | list }}"
  loop_control:
    loop_var: resource_item

# Create unified format variables (same as servers) for easier usage
- name: Set load balancer data in unified format (always returns lists of IPs)
  ansible.builtin.set_fact:
    "{{ resource_item.name }}":
      ipv4: "{{ tfstate.resources | selectattr('type', 'equalto', resource_item.type) | selectattr('name', 'equalto', resource_item.name) | map(attribute='instances') | first | map(attribute='attributes.ipv4') | list }}"
      ipv6: "{{ tfstate.resources | selectattr('type', 'equalto', resource_item.type) | selectattr('name', 'equalto', resource_item.name) | map(attribute='instances') | first | map(attribute='attributes.ipv6') | list }}"
  loop: "{{ item.resources | selectattr('type', 'equalto', 'hcloud_load_balancer') | list }}"
  loop_control:
    loop_var: resource_item

- name: Debug extracted LB IPs in unified format
  ansible.builtin.debug:
    msg: "{{ resource_item.name }}.ipv4: {{ hostvars[inventory_hostname][resource_item.name].ipv4 | default('UNDEFINED') }}"
  loop: "{{ item.resources | selectattr('type', 'equalto', 'hcloud_load_balancer') | list }}"
  loop_control:
    loop_var: resource_item

# - name: Debug all hostvars
#   ansible.builtin.debug:
#     msg: "All variables starting with lb_: {{ hostvars[inventory_hostname] | dict2items | selectattr('key', 'match', '^lb_') | map(attribute='key') | list }}"
